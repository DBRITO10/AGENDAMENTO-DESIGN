<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>LOG√çSTICA - DESIGN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E90FF">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

    <style>
        body { background-color: #F0F8FF; font-family: 'Segoe UI', Arial, sans-serif; color: #333; padding: 10px; margin: 0; }
        h1 { background-color: #1E90FF; padding: 15px; border-radius: 8px; font-size: 24px; text-align: center; color: #fff; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        /* Estiliza√ß√£o da Tabela */
        table.dataTable { border-radius: 8px; overflow: hidden; background: white; }
        thead tr th { background: #4682B4 !important; color: #fff !important; padding: 12px !important; border: 1px solid #ddd; }
        td { padding: 10px !important; border-bottom: 1px solid #eee; text-align: center; font-size: 13px; }
        
        /* Dashboard */
        #dashboard { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 25px; }
        #totalCargasVisual { 
            font-size: 22px; font-weight: bold; color: #fff; background: #1E90FF;
            padding: 20px; border-radius: 12px; min-width: 200px; text-align: center;
            box-shadow: 0 6px 12px rgba(30, 144, 255, 0.3); display: flex; flex-direction: column;
        }
        #totalCargasVisual span { font-size: 14px; opacity: 0.9; text-transform: uppercase; margin-bottom: 5px; }

        /* Bot√µes e Filtros */
        .filter-select { background: #B0E0E6; border: none; padding: 6px 10px; border-radius: 4px; cursor: pointer; font-weight: bold; width: 100%; }
        .filter-select.applied { background-color: #FFD700; color: #000; }
        #btnShare { background:#28a745; color:#fff; padding:10px 20px; border:none; border-radius:6px; cursor:pointer; font-weight:bold; margin-bottom: 15px; }
        
        /* Status Cells */
        .status-cell { font-weight: bold; color: white !important; text-shadow: 1px 1px 2px rgba(0,0,0,0.3); border-radius: 4px; }
        
        /* Modais */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 450px; }
        .share-menu { display: none; position: absolute; background: white; border-radius: 8px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 2000; padding: 10px; }
        .share-option { padding: 12px; cursor: pointer; border-radius: 4px; margin-bottom: 5px; background: #f8f9fa; transition: 0.2s; }
        .share-option:hover { background: #e9ecef; }
    </style>
</head>
<body>

<div id="userBar" style="background:#4682B4; padding:12px; display:flex; justify-content:space-between; align-items:center; border-radius:8px; margin-bottom:15px; color: white;">
    <button onclick="history.back()" style="background:none; border:none; color:white; font-size:20px; cursor:pointer;">‚¨Ö Voltar</button>
    <strong id="welcomeUser">Carregando...</strong>
    <button onclick="logout()" style="background:#dc3545; color:white; border:none; padding:8px 15px; border-radius:6px; font-weight:bold; cursor:pointer;">Sair</button>
</div>

<h1>PAINEL DE RECEBIMENTO: DESIGN</h1>

<div id="dashboard">
    <div id="totalCargasVisual">
        <span>Cargas Hoje (Design)</span>
        <div id="numCargas">0</div>
    </div>
    <div style="width: 100%; max-width: 400px; height: 250px;">
        <canvas id="statusChart"></canvas>
    </div>
</div>

<div style="text-align: right;">
    <button id="btnShare">üì§ Exportar Relat√≥rios</button>
    <div id="shareMenu" class="share-menu">
        <div class="share-option" onclick="exportPDF()">üìÑ Gerar PDF Profissional</div>
        <div class="share-option" onclick="exportExcel()">üìä Planilha Excel (.xlsx)</div>
    </div>
</div>

<table id="planilha" class="display nowrap" style="width:100%">
    <thead>
        <tr class="headers"></tr>
        <tr class="filters"></tr>
    </thead>
    <tbody></tbody>
</table>

<script>
const sheetID = "1Ore02M4GARvE6hldNDZmiVNDrABb4dgaZO7wlMY-fjs";
const gid = "2090543957";
const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=${gid}`;
const colunasDesejadas = ["ORDEM DE AGENDA","DATA","CENTRAL","CARGAS","STATUS","FORNECEDOR","TIPO DE PRODUTO", "BOX"];

const coresStatus = {
    "CARGA RECEBIDA": '#4CAF50', "NO PATIO - FICOU P/ AMANH√É": '#3ACFB9', 
    "CANCELADA": '#7a002b', "SOB AJUSTE": '#8B27F5',
    "NO PATIO - SOB ENCAIXE": '#ff7625', "NO PATIO - FICOU DE ONTEM": '#B249BF',
    "EM RECEBIMENTO": '#FFC107', "NO PATIO": '#03A9F4',
    "EM ATRASO": '#F44336', "REAGENDA": '#9B591B'
};

let dataTable, myChart;
let coresData = [], coresCentral = [];

// Autentica√ß√£o b√°sica
document.getElementById("welcomeUser").textContent = "Ol√°, " + (localStorage.getItem("username") || "Gestor Design");
function logout() { localStorage.clear(); window.location.href = "login.html"; }

// Carregamento de Dados
Papa.parse(csvUrl, { download: true, header: true, complete: function (results) {
    let rawData = results.data;
    
    // 1. FILTRO DE N√çVEL PROFISSIONAL (DESIGN APENAS)
    const data = rawData.filter(row => {
        const forner = (row["FORNECEDOR"] || "").toString().trim().toUpperCase();
        return forner === "DESIGN";
    });

    // Limpeza de espa√ßos
    data.forEach(row => {
        Object.keys(row).forEach(k => { if(row[k]) row[k] = row[k].toString().trim(); });
    });

    renderTable(data);
}});

function renderTable(data) {
    const headerRow = document.querySelector(".headers");
    const filterRow = document.querySelector(".filters");
    const body = document.querySelector("#planilha tbody");

    colunasDesejadas.forEach(col => {
        headerRow.innerHTML += `<th>${col}</th>`;
        filterRow.innerHTML += `<th><button class="filter-select">${col}</button></th>`;
    });

    data.forEach((row, i) => {
        let tr = "<tr>";
        colunasDesejadas.forEach(col => {
            let val = row[col] || "";
            if(col === "STATUS") {
                tr += `<td class="status-cell" style="background:${coresStatus[val] || '#666'}">${val}</td>`;
            } else {
                tr += `<td>${val}</td>`;
            }
        });
        tr += "</tr>";
        body.innerHTML += tr;
    });

    dataTable = $("#planilha").DataTable({
        paging: false, scrollX: true, info: false,
        order: [[0, 'desc']],
        language: { search: "Filtrar na tela:" }
    });

    updateDashboard();
    dataTable.on('draw', updateDashboard);
}

function updateDashboard() {
    const filteredData = dataTable.rows({search:'applied'}).data().toArray();
    document.getElementById("numCargas").textContent = filteredData.length;
    renderChart(filteredData);
}

function renderChart(data) {
    const counts = {};
    data.forEach(r => { const s = r[4]; counts[s] = (counts[s] || 0) + 1; });
    
    if(myChart) myChart.destroy();
    myChart = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(counts),
            datasets: [{ data: Object.values(counts), backgroundColor: Object.keys(counts).map(s => coresStatus[s]) }]
        },
        options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
    });
}

// Exporta√ß√µes
function exportPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    doc.text("Relat√≥rio de Cargas Design - Simonetti", 14, 15);
    doc.autoTable({
        head: [colunasDesejadas],
        body: dataTable.rows({search:'applied'}).data().toArray(),
        startY: 20,
        theme: 'grid',
        styles: { fontSize: 8 }
    });
    doc.save("Cargas_Design.pdf");
}

function exportExcel() {
    const data = dataTable.rows({search:'applied'}).data().toArray();
    const ws = XLSX.utils.aoa_to_sheet([colunasDesejadas, ...data]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Design");
    XLSX.writeFile(wb, "Cargas_Design.xlsx");
}

// Menu de exporta√ß√£o
$("#btnShare").click(function(e) {
    $("#shareMenu").css({ top: e.pageY + 10, left: e.pageX - 100 }).toggle();
});
$(document).click(function(e) { if(!$(e.target).closest('#btnShare').length) $("#shareMenu").hide(); });

</script>
</body>
</html>
