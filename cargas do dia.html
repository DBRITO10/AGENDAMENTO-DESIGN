<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>CARGAS DO DIA - DESIGN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E90FF">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

    <style>
        body { background-color: #F0F8FF; font-family: 'Segoe UI', Arial, sans-serif; color: #333; padding: 10px; margin: 0; }
        
        /* Cabe√ßalho superior */
        #userBar { background:#1E90FF; padding:10px 20px; display:flex; justify-content:space-between; align-items:center; border-radius:8px; margin-bottom:15px; color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        #welcomeUser { font-weight: 600; font-size: 16px; } /* Alinhado √† esquerda por padr√£o no flex */
        
        h1 { background: white; color: #1E90FF; padding: 15px; border-radius: 8px; font-size: 24px; text-align: center; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Tabela Profissional */
        .dataTables_wrapper { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        table.dataTable thead th { background-color: #4682B4 !important; color: white !important; padding: 12px 8px !important; border: 1px solid #ddd !important; }
        
        /* Bot√µes de Filtro na Tabela */
        .filter-select { width: 90%; padding: 5px; font-size: 11px; background: #E0F2F1; border: 1px solid #B2DFDB; border-radius: 4px; cursor: pointer; margin-top: 5px; font-weight: bold; color: #00796B; transition: 0.3s; }
        .filter-select:hover { background: #B2DFDB; }
        .filter-select.applied { background: #FFD700 !important; color: #000; border-color: #FFA000; }
        .filter-fixed { width: 90%; padding: 5px; font-size: 11px; background: #333; color: #fff; border: none; border-radius: 4px; margin-top: 5px; cursor: default; }

        /* Estiliza√ß√£o das exporta√ß√µes */
        .export-buttons { display: flex; gap: 10px; margin-bottom: 15px; justify-content: center; }
        .btn-exp { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; color: white; display: flex; align-items: center; gap: 8px; transition: transform 0.2s; }
        .btn-exp:active { transform: scale(0.95); }
        .btn-pdf { background-color: #e74c3c; }
        .btn-excel { background-color: #27ae60; }

        /* Status e C√©lulas */
        .status-cell { font-weight: bold; color: white !important; border-radius: 4px; text-shadow: 1px 1px 1px rgba(0,0,0,0.3); }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; backdrop-filter: blur(2px); }
        .modal-content { background: white; padding: 25px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .modal-checkbox-list label { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        .disabled-option { color: #ccc; background: #fafafa; cursor: not-allowed; }

        #modalButtons { display: flex; gap: 5px; margin-bottom: 15px; position: sticky; top: -25px; background: white; padding: 10px 0; z-index: 5; border-bottom: 2px solid #1E90FF; }
        #modalButtons button { flex: 1; padding: 8px; border: none; border-radius: 4px; color: white; font-weight: bold; cursor: pointer; font-size: 11px; }

        /* Celular */
        @media (max-width: 768px) {
            h1 { font-size: 18px; }
            .btn-exp { flex: 1; font-size: 12px; }
            #welcomeUser { font-size: 13px; }
        }
    </style>
</head>
<body>

<div id="userBar">
    <div style="display: flex; align-items: center; gap: 15px;">
        <button onclick="history.back()" style="background: none; border: none; color: white; font-size: 22px; cursor: pointer;">‚Üê</button>
        <span id="welcomeUser"></span>
    </div>
    <button onclick="logout()" style="background: rgba(255,255,255,0.2); border: 1px solid white; color: white; padding: 5px 15px; border-radius: 4px; cursor: pointer; font-weight: bold;">Sair</button>
</div>

<h1>CARGAS DO DIA</h1>

<div class="export-buttons">
    <button class="btn-exp btn-pdf" onclick="exportarPDF()">
        <span>üìÑ</span> PDF Profissional
    </button>
    <button class="btn-exp btn-excel" onclick="exportarExcel()">
        <span>üìä</span> Excel (Planilha)
    </button>
</div>

<div style="max-width: 1100px; margin: 0 auto;">
    <div id="totalCargasVisual" style="text-align: center; font-size: 20px; font-weight: bold; color: #1E90FF; margin-bottom: 15px;">Total de Cargas: 0</div>
    
    <table id="planilha" class="display nowrap" style="width:100%">
        <thead>
            <tr id="headerRow"></tr>
            <tr id="filterRow"></tr>
        </thead>
        <tbody></tbody>
    </table>

    <div style="margin-top: 30px; display: flex; justify-content: center;">
        <div style="width: 100%; max-width: 500px; height: 350px;">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<div id="filterModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <div id="modalButtons">
            <button style="background:#3498db" id="btnAll">Todos</button>
            <button style="background:#e67e22" id="btnNone">Limpar</button>
            <button style="background:#2ecc71" id="btnApply">Aplicar</button>
            <button style="background:#95a5a6" id="btnBack">Voltar</button>
        </div>
        <div id="modalList" class="modal-checkbox-list"></div>
    </div>
</div>

<script>
// Configura√ß√µes Iniciais
const sheetID = "1Ore02M4GARvE6hldNDZmiVNDrABb4dgaZO7wlMY-fjs";
const gid = "2090543957";
const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=${gid}`;
const colunas = ["ORDEM DE AGENDA","DATA","CENTRAL","CARGAS","STATUS","FORNECEDOR","TIPO DE PRODUTO", "BOX"];
const coresStatus = { "CARGA RECEBIDA": '#4CAF50', "NO PATIO - FICOU P/ AMANH√É": '#3ACFB9', "CANCELADA": '#7a002b', "SOB AJUSTE": '#8B27F5', "NO PATIO - SOB ENCAIXE": '#ff7625', "NO PATIO - FICOU DE ONTEM": '#B249BF', "EM RECEBIMENTO": '#FFC107', "NO PATIO": '#03A9F4', "EM ATRASO": '#F44336', "REAGENDA": '#9B591B' };

let dataTable, myChart;

// Login
if (localStorage.getItem("isLoggedIn") !== "true") window.location.href = "login.html";
document.getElementById("welcomeUser").textContent = "Bem-vindo, " + (localStorage.getItem("username") || "Usu√°rio");
function logout(){ localStorage.clear(); window.location.href = "login.html"; }

// Processamento
Papa.parse(csvUrl, { download: true, header: true, complete: function(results) {
    let data = results.data.filter(r => (r["FORNECEDOR"] || "").trim().toUpperCase() === "DESIGN");
    
    const hRow = document.getElementById("headerRow");
    const fRow = document.getElementById("filterRow");
    
    colunas.forEach(c => {
        hRow.innerHTML += `<th>${c}</th>`;
        if(c === "FORNECEDOR") fRow.innerHTML += `<th><button class="filter-fixed">DESIGN</button></th>`;
        else fRow.innerHTML += `<th><button class="filter-select" data-col="${c}">Filtrar</button></th>`;
    });

    const tbody = document.querySelector("#planilha tbody");
    data.forEach(row => {
        let tr = "<tr>";
        colunas.forEach(c => {
            let val = (row[c] || "").trim() || "SEM INF";
            let style = "";
            if(c === "STATUS") style = `class="status-cell" style="background:${coresStatus[val] || '#4682B4'}"`;
            if((c === "DATA" || c === "CENTRAL") && val.startsWith('*')) {
                val = val.replace(/\*/g, '');
                style = `style="color:red; font-weight:bold"`;
            }
            tr += `<td ${style}>${val}</td>`;
        });
        tbody.innerHTML += tr + "</tr>";
    });

    dataTable = $("#planilha").DataTable({
        paging: false, scrollX: true, info: false, order: [[0, 'desc']],
        language: { search: "Buscar:" }
    });

    // Cascata e Modal
    $(document).on('click', '.filter-select', function() {
        const colIdx = $(this).closest('th').index();
        const allVals = dataTable.column(colIdx, {filter:'none'}).data().unique().sort().toArray();
        
        const currentSearch = dataTable.column(colIdx).search();
        dataTable.column(colIdx).search('').draw();
        const possible = dataTable.column(colIdx, {filter:'applied'}).data().unique().toArray();
        dataTable.column(colIdx).search(currentSearch).draw();

        const saved = JSON.parse(localStorage.getItem('f_'+colIdx) || "[]");
        let html = '';
        allVals.forEach(v => {
            const isChecked = saved.includes(v) ? 'checked' : '';
            const isValid = possible.includes(v);
            const isDis = (!isValid && !saved.includes(v));
            html += `<label class="${isDis ? 'disabled-option' : ''}">
                <input type="checkbox" value="${v}" ${isChecked} ${isDis ? 'disabled' : ''}> ${v}
            </label>`;
        });
        $('#modalList').html(html);
        $('#filterModalOverlay').data('idx', colIdx).fadeIn(200).css('display','flex');
    });

    $('#btnApply').click(function() {
        const idx = $('#filterModalOverlay').data('idx');
        const sel = $('#modalList input:checked').map(function(){ return this.value; }).get();
        localStorage.setItem('f_'+idx, JSON.stringify(sel));
        const reg = sel.map(v => '^'+$.fn.dataTable.util.escapeRegex(v)+'$').join('|');
        dataTable.column(idx).search(reg, true, false).draw();
        
        const btn = $(`.filter-select:eq(${idx > 5 ? idx-1 : idx})`); // Ajuste de √≠ndice por causa do bot√£o fixo
        sel.length > 0 ? btn.addClass('applied').text('Ativo') : btn.removeClass('applied').text('Filtrar');
        $('#filterModalOverlay').hide();
    });

    $('#btnAll').click(() => $('#modalList input:not(:disabled)').prop('checked', true));
    $('#btnNone').click(() => $('#modalList input').prop('checked', false));
    $('#btnBack').click(() => $('#filterModalOverlay').hide());

    dataTable.on('draw', () => {
        const count = dataTable.rows({search:'applied'}).count();
        $('#totalCargasVisual').text("Total de Cargas: " + count);
        updateChart();
    });
    dataTable.draw();
}});

function updateChart() {
    const counts = {};
    const statusIdx = colunas.indexOf("STATUS");
    dataTable.rows({search:'applied'}).data().each(r => {
        counts[r[statusIdx]] = (counts[r[statusIdx]] || 0) + 1;
    });
    if(myChart) myChart.destroy();
    myChart = new Chart(document.getElementById('statusChart'), {
        type: 'pie',
        data: {
            labels: Object.keys(counts).map(k => `${k} (${counts[k]})`),
            datasets: [{ data: Object.values(counts), backgroundColor: Object.keys(counts).map(k => coresStatus[k] || '#888') }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

// Exporta√ß√µes
function exportarPDF() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    doc.setFontSize(18);
    doc.text("Relat√≥rio de Cargas - Fornecedor DESIGN", 14, 15);
    doc.setFontSize(10);
    doc.text(`Gerado em: ${new Date().toLocaleString()}`, 14, 22);
    
    doc.autoTable({
        startY: 25,
        head: [colunas],
        body: dataTable.rows({search:'applied'}).data().toArray(),
        theme: 'grid',
        headStyles: { fillColor: [70, 130, 180] },
        styles: { fontSize: 8 }
    });
    doc.save("Cargas_Design.pdf");
}

function exportarExcel() {
    const ws = XLSX.utils.aoa_to_sheet([colunas, ...dataTable.rows({search:'applied'}).data().toArray()]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Cargas");
    XLSX.writeFile(wb, "Cargas_Design.xlsx");
}
</script>
</body>
</html>
