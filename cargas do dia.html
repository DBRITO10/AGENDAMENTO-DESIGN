<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>SISTEMA DE CARGAS - DESIGN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#1E90FF">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

    <style>
        * { box-sizing: border-box; }
        body { background-color: #F0F8FF; font-family: 'Segoe UI', sans-serif; margin: 0; padding: 10px; width: 100vw; }
        
        #userBar { background:#1E90FF; padding:12px 20px; display:flex; justify-content:space-between; align-items:center; border-radius:8px; margin-bottom:10px; color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.15); }
        #welcomeContainer { display: flex; align-items: center; gap: 15px; }
        #welcomeUser { font-weight: bold; font-size: 16px; }

        h1 { background: white; color: #1E90FF; padding: 12px; border-radius: 8px; font-size: 22px; text-align: center; margin: 10px 0; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        #topArea { display: flex; flex-direction: column; align-items: center; width: 100%; margin-bottom: 20px; }
        #chartWrapper { width: 100%; max-width: 450px; height: 320px; background: white; padding: 15px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.08); }
        #totalVisual { background: #1E90FF; color: white; padding: 10px 25px; border-radius: 30px; font-weight: bold; font-size: 18px; margin-top: -15px; z-index: 2; box-shadow: 0 4px 6px rgba(0,0,0,0.2); }

        .export-row { display: flex; gap: 10px; justify-content: center; margin: 15px 0; width: 100%; }
        .btn-export { border: none; padding: 10px 20px; border-radius: 6px; color: white; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 8px; font-size: 14px; }
        .btn-pdf { background: #d32f2f; }
        .btn-excel { background: #2e7d32; }

        .main-container { width: 100%; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        table.dataTable { width: 100% !important; margin: 0 !important; }
        thead th { background-color: #4682B4 !important; color: white !important; font-size: 13px; text-transform: uppercase; border: 1px solid #36648B !important; padding: 10px !important; }
        
        .filter-btn { width: 95%; margin-top: 5px; padding: 6px; font-size: 11px; border-radius: 4px; border: 1px solid #ccc; cursor: pointer; font-weight: bold; background: #f9f9f9; }
        .filter-btn.active { background: #FFD700; border-color: #DAA520; color: #000; }
        .filter-fixed { background: #333; color: #fff; cursor: default; border: none; }

        td { font-size: 13px; padding: 12px !important; text-align: center !important; border: 1px solid #eee !important; }
        .status-pill { font-weight: bold; color: white !important; border-radius: 4px; padding: 6px; display: inline-block; width: 100%; text-shadow: 1px 1px 1px rgba(0,0,0,0.2); }

        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-box { background: white; width: 90%; max-width: 400px; border-radius: 12px; overflow: hidden; display: flex; flex-direction: column; max-height: 85vh; }
        .modal-header { background: #1E90FF; color: white; padding: 15px; font-weight: bold; display: flex; justify-content: space-between; }
        .modal-body { padding: 10px; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 15px; background: #f1f1f1; display: flex; gap: 8px; }
        .modal-footer button { flex: 1; padding: 10px; border: none; border-radius: 5px; color: white; font-weight: bold; cursor: pointer; }
        
        label.opt { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #eee; cursor: pointer; }
        label.opt.locked { opacity: 0.4; background: #f5f5f5; cursor: not-allowed; }

        @media (max-width: 768px) {
            #chartWrapper { height: 280px; }
            .btn-export { flex: 1; font-size: 11px; }
        }
    </style>
</head>
<body>

<div id="userBar">
    <div id="welcomeContainer">
        <button onclick="history.back()" style="background:none; border:none; color:white; font-size:24px; cursor:pointer;">‚Üê</button>
        <span id="welcomeUser"></span>
    </div>
    <button onclick="logout()" style="background:rgba(255,255,255,0.2); border:1px solid white; color:white; padding:6px 12px; border-radius:4px; font-weight:bold; cursor:pointer;">Sair</button>
</div>

<h1>GERENCIAMENTO DE CARGAS - DESIGN</h1>

<div id="topArea">
    <div id="chartWrapper">
        <canvas id="statusChart"></canvas>
    </div>
    <div id="totalVisual">Cargas: 0</div>
</div>

<div class="export-row">
    <button class="btn-export btn-pdf" onclick="pdfPro()">üìÑ Exportar PDF Pro</button>
    <button class="btn-export btn-excel" onclick="excelPro()">üìä Planilha Excel</button>
</div>

<div class="main-container">
    <table id="planilha" class="display nowrap">
        <thead>
            <tr id="hNames"></tr>
            <tr id="hFilters"></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div class="modal-mask" id="mMask">
    <div class="modal-box">
        <div class="modal-header">
            <span id="mTitle">Filtrar</span>
            <span style="cursor:pointer" onclick="$('#mMask').hide()">‚úï</span>
        </div>
        <div class="modal-body" id="mBody"></div>
        <div class="modal-footer">
            <button style="background:#2196F3" onclick="selAll(true)">Todos</button>
            <button style="background:#f44336" onclick="selAll(false)">Limpar</button>
            <button style="background:#4CAF50" onclick="applyM()">Aplicar</button>
        </div>
    </div>
</div>

<script>
const sheetID = "1Ore02M4GARvE6hldNDZmiVNDrABb4dgaZO7wlMY-fjs";
const gid = "2090543957";
const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetID}/export?format=csv&gid=${gid}`;
const cols = ["ORDEM DE AGENDA","DATA","CENTRAL","CARGAS","STATUS","FORNECEDOR","TIPO DE PRODUTO", "BOX"];
const statusColors = { "CARGA RECEBIDA": '#4CAF50', "NO PATIO - FICOU P/ AMANH√É": '#3ACFB9', "CANCELADA": '#7a002b', "SOB AJUSTE": '#8B27F5', "NO PATIO - SOB ENCAIXE": '#ff7625', "NO PATIO - FICOU DE ONTEM": '#B249BF', "EM RECEBIMENTO": '#FFC107', "NO PATIO": '#03A9F4', "EM ATRASO": '#F44336', "REAGENDA": '#9B591B' };

let table, chart;

if (localStorage.getItem("isLoggedIn") !== "true") window.location.href = "login.html";
document.getElementById("welcomeUser").textContent = "Ol√°, " + (localStorage.getItem("username") || "Usu√°rio");
function logout(){ localStorage.clear(); window.location.href = "login.html"; }

Papa.parse(csvUrl, { download: true, header: true, complete: function(res) {
    let raw = res.data.filter(r => (r["FORNECEDOR"] || "").trim().toUpperCase() === "DESIGN");
    
    const hNames = document.getElementById("hNames");
    const hFilters = document.getElementById("hFilters");
    
    cols.forEach(c => {
        hNames.innerHTML += `<th>${c}</th>`;
        if(c === "FORNECEDOR") hFilters.innerHTML += `<th><button class="filter-btn filter-fixed">DESIGN</button></th>`;
        else hFilters.innerHTML += `<th><button class="filter-btn" data-col="${c}">Filtrar</button></th>`;
    });

    const tbody = document.querySelector("#planilha tbody");
    raw.forEach(r => {
        let rowHtml = "<tr>";
        cols.forEach(c => {
            let val = (r[c] || "").trim() || "SEM INF";
            let css = "";
            if(c === "STATUS") css = `class="status-pill" style="background:${statusColors[val] || '#666'}"`;
            if((c === "DATA" || c === "CENTRAL") && val.startsWith('*')) {
                val = val.replace(/\*/g,'');
                css = `style="color:red; font-weight:bold"`;
            }
            rowHtml += `<td><span ${css}>${val}</span></td>`;
        });
        tbody.innerHTML += rowHtml + "</tr>";
    });

    table = $("#planilha").DataTable({ 
        paging: false, 
        scrollX: true, 
        info: false, 
        order: [[0, 'desc']],
        language: { search: "Buscar na Tabela:" } // Corrigido para Portugu√™s
    });

    // Restaurar filtros salvos ao carregar
    cols.forEach((c, i) => {
        const saved = JSON.parse(localStorage.getItem('filter_'+i) || "[]");
        if(saved.length > 0) {
            const reg = saved.map(v => '^'+$.fn.dataTable.util.escapeRegex(v)+'$').join('|');
            table.column(i).search(reg, true, false);
            $(`.filter-btn[data-col="${c}"]`).addClass('active').text('Ativo');
        }
    });
    table.draw();

    // L√≥gica do Modal Corrigida
    $(document).on('click', '.filter-btn:not(.filter-fixed)', function() {
        const idx = $(this).closest('th').index();
        
        // Pega os dados puros (sem HTML) para n√£o dar erro no filtro
        const all = table.column(idx, {filter:'none'}).nodes().map(node => $(node).text().trim()).unique().sort().toArray();
        
        const curr = table.column(idx).search();
        table.column(idx).search('').draw();
        const validNow = table.column(idx, {filter:'applied'}).nodes().map(node => $(node).text().trim()).unique().toArray();
        table.column(idx).search(curr).draw();

        const saved = JSON.parse(localStorage.getItem('filter_'+idx) || "[]");
        let h = '';
        all.forEach(v => {
            if(v === "") return;
            const isSel = saved.includes(v) ? 'checked' : '';
            const isOk = validNow.includes(v);
            const lock = (!isOk && !saved.includes(v));
            h += `<label class="opt ${lock ? 'locked' : ''}">
                <input type="checkbox" value="${v}" ${isSel} ${lock ? 'disabled' : ''}> <span style="margin-left:8px">${v}</span>
            </label>`;
        });
        $('#mTitle').text(cols[idx]);
        $('#mBody').html(h);
        $('#mMask').data('idx', idx).fadeIn(200).css('display','flex');
    });

    table.on('draw', () => {
        const total = table.rows({search:'applied'}).count();
        $('#totalVisual').text("Cargas: " + total);
        updateChart();
    });
    updateChart();
}});

function updateChart() {
    const data = {};
    const sIdx = cols.indexOf("STATUS");
    table.rows({search:'applied'}).nodes().each(node => {
        const s = $(node).find('td').eq(sIdx).text().trim();
        data[s] = (data[s] || 0) + 1;
    });
    if(chart) chart.destroy();
    chart = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(data).map(k => `${k} (${data[k]})`),
            datasets: [{ data: Object.values(data), backgroundColor: Object.keys(data).map(k => statusColors[k] || '#888'), borderWidth: 2 }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } } } }
    });
}

function selAll(b) { $('#mBody input:not(:disabled)').prop('checked', b); }

function applyM() {
    const idx = $('#mMask').data('idx');
    const vals = $('#mBody input:checked').map(function(){ return this.value; }).get();
    localStorage.setItem('filter_'+idx, JSON.stringify(vals));
    const reg = vals.map(v => '^'+$.fn.dataTable.util.escapeRegex(v)+'$').join('|');
    table.column(idx).search(reg, true, false).draw();
    
    const btn = $(`.filter-btn[data-col="${cols[idx]}"]`);
    vals.length > 0 ? btn.addClass('active').text('Ativo') : btn.removeClass('active').text('Filtrar');
    $('#mMask').hide();
}

function pdfPro() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    doc.setFillColor(30, 144, 255);
    doc.rect(0, 0, 297, 20, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(16);
    doc.text("RELAT√ìRIO DE CARGAS - DESIGN", 15, 13);
    
    const rows = table.rows({search:'applied'}).nodes().map(node => {
        return $(node).find('td').map(function() { return $(this).text().trim(); }).get();
    }).toArray();

    doc.autoTable({
        startY: 25,
        head: [cols],
        body: rows,
        theme: 'striped',
        headStyles: { fillColor: [70, 130, 180], fontSize: 9 },
        styles: { fontSize: 8, halign: 'center' }
    });
    doc.save("Relatorio_Design.pdf");
}

function excelPro() {
    const rows = table.rows({search:'applied'}).nodes().map(node => {
        return $(node).find('td').map(function() { return $(this).text().trim(); }).get();
    }).toArray();
    const ws = XLSX.utils.aoa_to_sheet([cols, ...rows]);
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Cargas");
    XLSX.writeFile(wb, "Cargas_Design.xlsx");
}
</script>
</body>
</html>
