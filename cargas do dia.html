<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8" />
    <title>PAINEL EXCLUSIVO - DESIGN</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#000080">

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="stylesheet" href="https://cdn.datatables.net/1.13.4/css/jquery.dataTables.min.css" />
    <link rel="stylesheet" href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">

    <style>
        /* Ajuste de Alinhamento e Responsividade */
        body { background-color: #F0F8FF; font-family: Arial, sans-serif; margin: 0; padding: 10px; }
        h1 { background: #1E90FF; color: white; padding: 15px; border-radius: 8px; text-align: center; font-size: 24px; }
        
        .table-container { width: 100%; overflow-x: auto; background: white; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        table { width: 100% !important; border-collapse: collapse; }
        thead th { background: #4682B4; color: white; padding: 12px; border: 1px solid #ddd; white-space: nowrap; }
        
        /* BotÃµes de Filtro */
        .filter-select { width: 90%; padding: 8px; border-radius: 5px; border: 1px solid #ccc; cursor: pointer; font-weight: bold; background: #B0E0E6; }
        .filter-select.applied { background: #FFD700 !important; border-color: #DAA520; }
        .filter-select.fixed-design { background: #000080 !important; color: white !important; cursor: not-allowed; }

        /* Estilos de Status */
        .status-cell { font-weight: bold; color: white !important; text-shadow: 1px 1px 1px #000; text-align: center; border-radius: 4px; }

        /* Modal de Filtro Inteligente */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 9999; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 90%; max-width: 400px; border-radius: 12px; padding: 20px; max-height: 80vh; display: flex; flex-direction: column; }
        .modal-list { overflow-y: auto; flex-grow: 1; margin: 15px 0; border: 1px solid #eee; border-radius: 5px; }
        .modal-list label { display: flex; align-items: center; padding: 12px; border-bottom: 1px solid #f5f5f5; cursor: pointer; transition: 0.2s; }
        .modal-list label:hover { background: #f0f7ff; }
        .modal-list input { margin-right: 15px; transform: scale(1.3); }
        
        .modal-footer { display: flex; gap: 10px; }
        .modal-footer button { flex: 1; padding: 12px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
        #btnApply { background: #28a745; color: white; }
        #btnBack { background: #6c757d; color: white; }

        #totalCargasVisual { font-size: 18px; font-weight: bold; color: #000080; margin: 15px 0; }
    </style>
</head>
<body>

<div id="userBar" style="background:#4682B4; padding:10px; display:flex; justify-content:space-between; color:white;">
    <span id="welcomeUser">Bem-vindo, Design</span>
    <button onclick="location.href='login.html'" style="background:none; border:1px solid white; color:white; cursor:pointer; border-radius:4px; padding:2px 10px;">Sair</button>
</div>

<h1>PAINEL DE CARGAS - DESIGN</h1>

<div style="text-align: center; margin-bottom: 20px;">
    <div style="max-width: 400px; margin: 0 auto;"><canvas id="statusChart"></canvas></div>
    <div id="totalCargasVisual">Total de Cargas: 0</div>
    <button id="btnExport" style="background:#1E90FF; color:white; padding:10px 20px; border:none; border-radius:5px; font-weight:bold; cursor:pointer;">ðŸ“¥ Exportar PDF Profissional</button>
</div>

<div class="table-container">
    <table id="planilha" class="display nowrap">
        <thead>
            <tr class="headers"></tr>
            <tr class="filters"></tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<div id="modalFiltro" class="modal-overlay">
    <div class="modal-content">
        <h3 id="modalTitle" style="margin-top:0; color:#1E90FF; border-bottom:2px solid #1E90FF; padding-bottom:5px;"></h3>
        <div id="modalList" class="modal-list"></div>
        <div class="modal-footer">
            <button id="btnBack">VOLTAR</button>
            <button id="btnApply">APLICAR FILTRO</button>
        </div>
    </div>
</div>

<script>
const csvUrl = `https://docs.google.com/spreadsheets/d/1Ore02M4GARvE6hldNDZmiVNDrABb4dgaZO7wlMY-fjs/export?format=csv&gid=2090543957`;
const colunasDesejadas = ["ORDEM DE AGENDA","DATA","CENTRAL","CARGAS","STATUS","FORNECEDOR","TIPO DE PRODUTO", "BOX"];
const coresStatus = {
    "CARGA RECEBIDA": '#4CAF50', "NO PATIO - FICOU P/ AMANHÃƒ": '#3ACFB9', "CANCELADA": '#7a002b',    
    "SOB AJUSTE": '#8B27F5', "NO PATIO - SOB ENCAIXE": '#ff7625', "NO PATIO - FICOU DE ONTEM": '#B249BF',
    "EM RECEBIMENTO": '#FFC107', "NO PATIO": '#03A9F4', "EM ATRASO": '#F44336', "REAGENDA": '#9B591B'
};

let dataTable, myChart;
const fIdx = colunasDesejadas.indexOf("FORNECEDOR");
const dIdx = colunasDesejadas.indexOf("DATA");

// Plugin para ordenar data brasileira corretamente
$.fn.dataTable.ext.type.order['date-br-pre'] = function(d) {
    if (!d) return 0;
    const parts = d.split('/');
    return (parts[2] + parts[1] + parts[0]) * 1;
};

Papa.parse(csvUrl, { download: true, header: true, complete: function(results) {
    const data = results.data;
    const hTr = document.querySelector(".headers");
    const fTr = document.querySelector(".filters");
    const tbody = document.querySelector("#planilha tbody");

    colunasDesejadas.forEach(col => {
        hTr.innerHTML += `<th>${col}</th>`;
        fTr.innerHTML += `<th><button class="filter-select" data-col="${col}">${col === "FORNECEDOR" ? "DESIGN" : "Filtrar"}</button></th>`;
    });

    data.forEach(row => {
        if(!row["ORDEM DE AGENDA"]) return;
        let tr = "<tr>";
        colunasDesejadas.forEach(col => {
            let val = row[col] || "";
            if(col === "STATUS") tr += `<td class="status-cell" style="background:${coresStatus[val] || '#4682B4'}">${val}</td>`;
            else tr += `<td>${val}</td>`;
        });
        tbody.innerHTML += tr + "</tr>";
    });

    dataTable = $("#planilha").DataTable({
        paging: false, info: false, scrollX: true, order: [[0, 'desc']],
        columnDefs: [{ type: 'date-br', targets: dIdx }]
    });

    // TRAVA O FORNECEDOR DESIGN
    dataTable.column(fIdx).search('^DESIGN$', true, false).draw();
    $(`.filter-select[data-col="FORNECEDOR"]`).addClass('fixed-design').prop('disabled', true);

    atualizarResumo();

    // LÃ³gica do Filtro Inteligente (Cascata)
    $(document).on('click', '.filter-select', function() {
        const colIndex = $(this).closest('th').index();
        if(colIndex === fIdx) return;

        const colName = colunasDesejadas[colIndex];
        // Pega apenas o que estÃ¡ visÃ­vel (Filtro Cascata)
        const visibleData = dataTable.column(colIndex, {search:'applied'}).data().unique().sort().toArray();
        const currentSearch = dataTable.column(colIndex).search();
        
        let html = "";
        visibleData.forEach(val => {
            if(!val) return;
            const checked = currentSearch.includes(val) ? "checked" : "";
            html += `<label><input type="checkbox" value="${val}" ${checked}> ${val}</label>`;
        });

        $('#modalTitle').text("Filtrar " + colName);
        $('#modalList').html(html);
        $('#modalFiltro').data('col-idx', colIndex).fadeIn();
    });

    $('#btnApply').click(function() {
        const idx = $('#modalFiltro').data('col-idx');
        const selected = $('#modalList input:checked').map(function(){ return this.value; }).get();
        
        if(selected.length > 0) {
            const regex = selected.map(v => '^' + $.fn.dataTable.util.escapeRegex(v) + '$').join('|');
            dataTable.column(idx).search(regex, true, false).draw();
            $(`.filter-select`).eq(idx).addClass('applied').text('APLICADO');
        } else {
            dataTable.column(idx).search('').draw();
            $(`.filter-select`).eq(idx).removeClass('applied').text('Filtrar');
        }
        $('#modalFiltro').fadeOut();
        atualizarResumo();
    });

    $('#btnBack').click(() => $('#modalFiltro').fadeOut());
}});

function atualizarResumo() {
    const filtered = dataTable.rows({search:'applied'}).data().toArray();
    document.getElementById("totalCargasVisual").textContent = "Total Design: " + filtered.length;
    renderizarGrafico(filtered);
}

function renderizarGrafico(data) {
    const sIdx = colunasDesejadas.indexOf("STATUS");
    const counts = {};
    data.forEach(r => { counts[r[sIdx]] = (counts[r[sIdx]] || 0) + 1; });
    
    if (myChart) myChart.destroy();
    myChart = new Chart(document.getElementById('statusChart'), {
        type: 'doughnut',
        data: {
            labels: Object.keys(counts),
            datasets: [{ data: Object.values(counts), backgroundColor: Object.keys(counts).map(k => coresStatus[k] || '#ccc') }]
        },
        options: { plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
    });
}

// PDF Profissional
$('#btnExport').click(function() {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF('l', 'mm', 'a4');
    const filteredData = dataTable.rows({search:'applied'}).data().toArray();

    doc.setFillColor(0, 0, 128);
    doc.rect(0, 0, 297, 30, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(18);
    doc.text("MÃ“VEIS SIMONETTI - RELATÃ“RIO DESIGN", 15, 15);
    doc.setFontSize(10);
    doc.text(`TOTAL DE CARGAS: ${filteredData.length} | DATA: ${new Date().toLocaleDateString()}`, 15, 25);

    doc.autoTable({
        startY: 35,
        head: [colunasDesejadas],
        body: filteredData,
        theme: 'grid',
        styles: { fontSize: 7, halign: 'center' },
        headStyles: { fillColor: [0, 0, 100] },
        didParseCell: function(data) {
            if(data.column.index === colunasDesejadas.indexOf("STATUS") && data.section === 'body') {
                const color = coresStatus[data.cell.raw];
                if(color) {
                    data.cell.styles.fillColor = hexToRgb(color);
                    data.cell.styles.textColor = [255, 255, 255];
                }
            }
        }
    });
    doc.save("Relatorio_Design.pdf");
});

function hexToRgb(hex) {
    const r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
    return [r, g, b];
}
</script>
</body>
</html>
